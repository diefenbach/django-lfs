{% extends "manage/manage_base.html" %}
{% load i18n lfs_manage_tags lfs_tags static %}

{% block section %}send-rating-mails{% endblock %}
{% block left-slot-wrapper %}{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h1 class="card-title h3 mb-0">
                            <i class="bi bi-envelope-check me-2"></i>
                            {% trans 'Rating Mails' %}
                        </h1>
                    </div>
                    <div class="card-body">
                        <h2 class="h4 mb-4">{% trans 'Send rating mails' %}</h2>

                        {% if eligible_orders %}
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                {% trans "There are" %} <strong>{{ eligible_orders|length }}</strong> {% trans "orders eligible for rating mails." %}
                            </div>
                            
                            <form action="{% url 'lfs_send_rating_mails' %}" method="post" class="mb-4">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   name="test" 
                                                   id="test-checkbox"
                                                   checked="checked">
                                            <label class="form-check-label" for="test-checkbox">
                                                <strong>{% trans "Test" %}</strong> - {% trans "The mails will get to the shop notification email adresses" %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   name="bcc" 
                                                   id="bcc-checkbox"
                                                   checked="checked">
                                            <label class="form-check-label" for="bcc-checkbox">
                                                <strong>{% trans "Send copy" %}</strong> - {% trans "The mails will also send to the shop notification email adresses (if not in test mode)" %}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send me-2"></i>
                                        {% trans "Send rating mails" %}
                                    </button>
                                </div>
                            </form>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {% trans "No orders are currently eligible for rating mails." %}
                            </div>
                        {% endif %}

                        {% if display_orders_sent %}
                            <hr class="my-4">
                            <h2 class="h4 mb-4">{% trans "Rating mails sent" %}</h2>
                            {% if orders_sent %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th scope="col">{% trans "ID" %}</th>
                                                <th scope="col">{% trans "Name" %}</th>
                                                <th scope="col">{% trans "E-Mail" %}</th>
                                                <th scope="col">{% trans "Date" %}</th>
                                                <th scope="col">{% trans "Date Closed" %}</th>
                                                <th scope="col" class="text-end">{% trans "Price" %}</th>
                                                <th scope="col" class="text-center">{% trans "View" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for order in orders_sent %}
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-secondary">{{ order.id }}</span>
                                                    </td>
                                                    <td>
                                                        <strong>{{ order.customer_firstname }} {{ order.customer_lastname }}</strong>
                                                    </td>
                                                    <td>
                                                        <a href="mailto:{{ order.customer_email }}" class="text-decoration-none">
                                                            {{ order.customer_email }}
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ order.created|date:_("DATETIME_FORMAT") }}</small>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ order.state_modified|date:_("DATETIME_FORMAT") }}</small>
                                                    </td>
                                                    <td class="text-end">
                                                        <strong>{{ order.price|currency:request }}</strong>
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="{% url 'lfs_manage_order' order.id %}" 
                                                           class="btn btn-sm btn-outline-primary"
                                                           title="{% trans 'View order' %}">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-light text-center">
                                    <i class="bi bi-inbox me-2"></i>
                                    {% trans "No e-mails have been sent" %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
