{% load i18n static %}

<div class="modal fade" id="imageBrowserModal" tabindex="-1" aria-labelledby="imageBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageBrowserModalLabel">{% trans "Select Image" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body">
                <div class="search-container mb-3">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" id="searchInput" class="form-control" placeholder="{% trans 'Search images...' %}">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2">
                                <select id="sizeSelect" class="form-select">
                                    <option value="">{% trans "Original" %}</option>
                                </select>
                                <button class="btn btn-primary" id="insertBtn" disabled>
                                    <i class="bi bi-check-circle"></i> {% trans "Insert" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="imageContainer" class="image-grid">
                    <div class="loading text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">{% trans "Loading..." %}</span>
                        </div>
                    </div>
                </div>

                <div id="pagination" class="d-flex justify-content-center mt-3">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Ensure modal appears above TinyMCE */
#imageBrowserModal {
    z-index: 9999 !important;
}

#imageBrowserModal .modal-backdrop {
    z-index: 9998 !important;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    max-height: 60vh;
    overflow-y: auto;
}
.image-card {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}
.image-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.image-card.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}
.image-thumb {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 0.375rem 0.375rem 0 0;
}
.search-container {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 1rem 0;
    border-bottom: 1px solid #dee2e6;
}
.loading {
    text-align: center;
    padding: 2rem;
}
.no-images {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}
</style>

<script>
class TinyMCEImageBrowserModal {
    constructor() {
        this.currentPage = 1;
        this.totalPages = 1;
        this.selectedImage = null;
        this.searchQuery = '';
        this.availableSizes = [];
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadImages();
    }
    
    bindEvents() {
        document.getElementById('searchBtn').addEventListener('click', () => this.search());
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.search();
        });
        document.getElementById('insertBtn').addEventListener('click', () => this.insertImage());
        document.getElementById('sizeSelect').addEventListener('change', () => this.updateInsertButton());
        
        // Reset when modal is shown
        document.getElementById('imageBrowserModal').addEventListener('show.bs.modal', () => {
            this.reset();
        });
    }
    
    reset() {
        this.selectedImage = null;
        this.searchQuery = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('insertBtn').disabled = true;
        document.querySelectorAll('.image-card').forEach(c => c.classList.remove('selected'));
    }
    
    async loadImages(page = 1) {
        this.currentPage = page;
        const container = document.getElementById('imageContainer');
        container.innerHTML = '<div class="loading"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>';
        
        try {
            const params = new URLSearchParams({
                page: page,
                q: this.searchQuery
            });
            
            const response = await fetch(`{% url 'tinymce_image_browser_api' %}?${params}`);
            const data = await response.json();
            
            this.renderImages(data.images);
            this.renderPagination(data.pagination);
            this.updateSizeOptions(data.images);
        } catch (error) {
            console.error('Error loading images:', error);
            container.innerHTML = '<div class="no-images"><i class="bi bi-exclamation-triangle"></i><br>{% trans "Error loading images" %}</div>';
        }
    }
    
    renderImages(images) {
        const container = document.getElementById('imageContainer');
        
        if (images.length === 0) {
            container.innerHTML = '<div class="no-images"><i class="bi bi-images"></i><br>{% trans "No images found" %}</div>';
            return;
        }
        
        container.innerHTML = images.map(image => `
            <div class="card image-card" data-image-url="${image.value}" data-image-title="${image.text}">
                <img src="${image.thumb}" alt="${image.alt}" class="image-thumb">
                <div class="card-body p-2">
                    <h6 class="card-title small mb-0" title="${image.text}">${image.text}</h6>
                </div>
            </div>
        `).join('');
        
        // Bind click events
        container.querySelectorAll('.image-card').forEach(card => {
            card.addEventListener('click', () => this.selectImage(card));
        });
    }
    
    renderPagination(pagination) {
        const container = document.getElementById('pagination');
        this.totalPages = pagination.total_pages;
        
        if (pagination.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<nav><ul class="pagination">';
        
        // Previous button
        if (pagination.has_previous) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.current_page - 1}">{% trans "Previous" %}</a></li>`;
        }
        
        // Page numbers
        const startPage = Math.max(1, pagination.current_page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const active = i === pagination.current_page ? 'active' : '';
            html += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        
        // Next button
        if (pagination.has_next) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.current_page + 1}">{% trans "Next" %}</a></li>`;
        }
        
        html += '</ul></nav>';
        container.innerHTML = html;
        
        // Bind pagination events
        container.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = parseInt(link.dataset.page);
                this.loadImages(page);
            });
        });
    }
    
    updateSizeOptions(images) {
        const sizeSelect = document.getElementById('sizeSelect');
        
        if (images.length > 0 && images[0].sizes) {
            this.availableSizes = images[0].sizes;
            sizeSelect.innerHTML = images[0].sizes.map(size => 
                `<option value="${size.value}">${size.label}</option>`
            ).join('');
        }
    }
    
    selectImage(card) {
        // Remove previous selection
        document.querySelectorAll('.image-card').forEach(c => c.classList.remove('selected'));
        
        // Select current card
        card.classList.add('selected');
        this.selectedImage = {
            url: card.dataset.imageUrl,
            title: card.dataset.imageTitle
        };
        
        this.updateInsertButton();
    }
    
    updateInsertButton() {
        const insertBtn = document.getElementById('insertBtn');
        insertBtn.disabled = !this.selectedImage;
    }
    
    search() {
        this.searchQuery = document.getElementById('searchInput').value;
        this.loadImages(1);
    }
    
    insertImage() {
        if (!this.selectedImage) return;
        
        const size = document.getElementById('sizeSelect').value;
        let finalUrl = this.selectedImage.url;
        
        // Apply size if selected
        if (size) {
            const urlParts = finalUrl.split('.');
            const extension = urlParts.pop();
            finalUrl = urlParts.join('.') + '.' + size + '.' + extension;
        }
        
        // Call TinyMCE callback
        if (window.tinymceImageCallback) {
            window.tinymceImageCallback(finalUrl, {
                title: this.selectedImage.title,
                alt: this.selectedImage.title
            });
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageBrowserModal'));
        modal.hide();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new TinyMCEImageBrowserModal();
});
</script>
